pipeline {
    agent any
    
    environment {
        // Docker Hub credentials ID (configured in Jenkins)
        DOCKER_HUB_CREDENTIALS = 'dockerhub-credentials'
        
        // Docker Hub username
        DOCKER_HUB_USERNAME = 'your-dockerhub-username'
        
        // Image names
        FRONTEND_IMAGE = "${DOCKER_HUB_USERNAME}/furnistyle-frontend"
        BACKEND_IMAGE = "${DOCKER_HUB_USERNAME}/furnistyle-backend"
        MONGODB_IMAGE = "${DOCKER_HUB_USERNAME}/furnistyle-mongodb"
        
        // Image tag - using build number and git commit
        IMAGE_TAG = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"
        
        // Directories
        FRONTEND_DIR = 'FurniStyle-FrontEnd'
        BACKEND_DIR = 'furnistyle-backend'
        MONGODB_DIR = 'mongodb'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Checking out code from repository..."
                    checkout scm
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo "Building Frontend Docker image..."
                    dir("${FRONTEND_DIR}") {
                        sh """
                            docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
                            docker tag ${FRONTEND_IMAGE}:${IMAGE_TAG} ${FRONTEND_IMAGE}:latest
                        """
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    echo "Building Backend Docker image..."
                    dir("${BACKEND_DIR}") {
                        sh """
                            docker build -t ${BACKEND_IMAGE}:${IMAGE_TAG} .
                            docker tag ${BACKEND_IMAGE}:${IMAGE_TAG} ${BACKEND_IMAGE}:latest
                        """
                    }
                }
            }
        }
        
        stage('Build MongoDB Image') {
            when {
                expression { 
                    // Only build MongoDB if custom Dockerfile exists
                    fileExists('mongodb/Dockerfile')
                }
            }
            steps {
                script {
                    echo "Building MongoDB Docker image..."
                    dir("${MONGODB_DIR}") {
                        sh """
                            docker build -t ${MONGODB_IMAGE}:${IMAGE_TAG} .
                            docker tag ${MONGODB_IMAGE}:${IMAGE_TAG} ${MONGODB_IMAGE}:latest
                        """
                    }
                }
            }
        }
        
        stage('Test Images') {
            steps {
                script {
                    echo "Testing Docker images..."
                    sh """
                        docker images | grep furnistyle
                    """
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "Logging into Docker Hub..."
                    docker.withRegistry('https://index.docker.io/v1/', "${DOCKER_HUB_CREDENTIALS}") {
                        echo "Pushing Frontend image..."
                        sh """
                            docker push ${FRONTEND_IMAGE}:${IMAGE_TAG}
                            docker push ${FRONTEND_IMAGE}:latest
                        """
                        
                        echo "Pushing Backend image..."
                        sh """
                            docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                            docker push ${BACKEND_IMAGE}:latest
                        """
                        
                        // Push MongoDB only if it was built
                        if (fileExists('mongodb/Dockerfile')) {
                            echo "Pushing MongoDB image..."
                            sh """
                                docker push ${MONGODB_IMAGE}:${IMAGE_TAG}
                                docker push ${MONGODB_IMAGE}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "Cleaning up old Docker images..."
                    sh """
                        docker image prune -f
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline executed successfully!"
            echo "Images pushed to Docker Hub:"
            echo "  - ${FRONTEND_IMAGE}:${IMAGE_TAG}"
            echo "  - ${BACKEND_IMAGE}:${IMAGE_TAG}"
            echo "  - ${MONGODB_IMAGE}:${IMAGE_TAG}"
        }
        
        failure {
            echo "Pipeline failed! Please check the logs."
        }
        
        always {
            echo "Cleaning up workspace..."
            cleanWs()
        }
    }
}
